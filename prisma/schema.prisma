generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String         @id @default(uuid()) @db.Uuid
  email         String         @unique
  phone         String         @unique
  passwordHash  String
  firstName     String
  lastName      String
  role          Role           @default(USER)
  dateOfBirth   DateTime?
  gender        String?
  isVerified    Boolean        @default(false)
  isActive      Boolean        @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  addresses     Address[]
  adminLogs     AdminLog[]
  auditLogs     AuditLog[]
  cartItems     CartItem[]
  notifications Notification[]
  orders        Order[]
  prescriptions Prescription[]
  reviews       Review[]
  savedKits     SavedKit[]
  sessions      Session[]
  wishlistItems WishlistItem[]

  @@index([email])
  @@index([phone])
  @@index([role])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String   @db.Uuid
  token        String   @unique
  refreshToken String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model AdminLog {
  id         String   @id @default(cuid())
  adminId    String   @db.Uuid
  action     String
  targetType String?
  targetId   String?
  details    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())
  admin      User     @relation(fields: [adminId], references: [id], onDelete: NoAction)

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_logs")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String   @db.Uuid
  action     String
  targetType String?
  targetId   String?
  details    String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Category {
  id            String        @id @default(cuid())
  name          String        @unique
  slug          String?       @unique
  description   String?
  imageUrl      String?
  icon          String?
  color         String?
  isActive      Boolean       @default(true)
  sortOrder     Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  products      Product[]
  subcategories Subcategory[]

  @@index([slug])
  @@map("categories")
}

model Subcategory {
  id          String    @id @default(cuid())
  name        String
  slug        String?
  description String?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  categoryId  String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([name, categoryId])
  @@map("subcategories")
}

model Product {
  id                   String         @id @default(cuid())
  name                 String
  slug                 String?        @unique
  description          String?
  shortDescription     String?
  sku                  String?        @unique
  brand                String?
  manufacturer         String?
  price                Float
  discountPrice        Float?
  costPrice            Float?
  requiresPrescription Boolean        @default(false)
  isOTC                Boolean        @default(true)
  strength             String?
  dosageForm           String?
  packSize             String?
  genericName          String?
  stockQuantity        Int            @default(0)
  minStockLevel        Int            @default(10)
  maxOrderQuantity     Int            @default(10)
  isActive             Boolean        @default(true)
  images               String?
  seoTitle             String?
  seoDescription       String?
  subcategoryId        String
  categoryId           String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  cartItems            CartItem[]
  inventoryRecords     Inventory[]
  orderItems           OrderItem[]
  category             Category?      @relation(fields: [categoryId], references: [id])
  subcategory          Subcategory    @relation(fields: [subcategoryId], references: [id])
  reviews              Review[]
  wishlistItems        WishlistItem[]

  @@index([slug])
  @@index([sku])
  @@index([categoryId])
  @@index([requiresPrescription])
  @@index([isActive])
  @@map("products")
}

model PickupLocation {
  id         String      @id @default(cuid())
  name       String      @unique
  address    String
  lat        Float?
  lng        Float?
  open_hours String
  is_active  Boolean     @default(true)
  inventory  Inventory[]

  @@index([lat, lng])
  @@map("pickup_locations")
}

model GeocodeCache {
  id          String        @id @default(cuid())
  query       String        @unique
  lat         Float?
  lng         Float?
  provider    String?
  status      GeocodeStatus @default(PENDING)
  attempts    Int           @default(0)
  lastAttempt DateTime?
  error       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("geocode_cache")
}

model Inventory {
  id             String         @id @default(cuid())
  productId      String
  locationId     String
  stock_quantity Int            @default(0)
  updated_at     DateTime       @updatedAt
  batchNumber    String?
  expiryDate     DateTime?
  quantity       Int
  costPrice      Decimal?
  supplierId     String?
  receivedDate   DateTime       @default(now())
  createdAt      DateTime       @default(now())
  location       PickupLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  product        Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier       Supplier?      @relation(fields: [supplierId], references: [id])

  @@unique([productId, locationId])
  @@index([productId])
  @@index([expiryDate])
  @@map("inventory")
}

model Supplier {
  id               String      @id @default(cuid())
  name             String
  contactPerson    String?
  email            String?
  phone            String?
  address          String?
  registrationId   String?
  isActive         Boolean     @default(true)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  inventoryRecords Inventory[]

  @@map("suppliers")
}

model Order {
  id              String          @id @default(cuid())
  userId          String          @db.Uuid
  orderNumber     String          @unique
  status          OrderStatus     @default(PENDING)
  totalAmount     Decimal
  discountAmount  Decimal         @default(0)
  shippingCost    Decimal         @default(0)
  paymentMethod   String?
  paymentStatus   PaymentStatus   @default(PENDING)
  paymentId       String?
  prescriptionId  String?
  shippingAddress String
  billingAddress  String?
  deliveryZoneId  String?
  deliveryDate    DateTime?
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  orderItems      OrderItem[]
  orderTracking   OrderTracking[]
  prescription    Prescription?   @relation(fields: [prescriptionId], references: [id])
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id         String   @id @default(cuid())
  orderId    String
  productId  String
  quantity   Int
  unitPrice  Decimal
  totalPrice Decimal
  createdAt  DateTime @default(now())
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model OrderTracking {
  id          String   @id @default(cuid())
  orderId     String
  status      String
  location    String?
  description String?
  createdAt   DateTime @default(now())
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_tracking")
}

model Prescription {
  id                String             @id @default(cuid())
  referenceNumber   String             @unique
  userId            String             @db.Uuid
  prescriptionImage String
  patientName       String?
  patientAge        Int?
  patientPhone      String?
  patientAddress    String?
  doctorName        String?
  doctorLicense     String?
  hospitalClinic    String?
  prescriptionDate  DateTime?
  items             String?
  status            PrescriptionStatus @default(PENDING)
  expiresAt         DateTime?
  isReorderable     Boolean            @default(true)
  verifiedBy        String?
  verifiedAt        DateTime?
  adminNotes        String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  orders            Order[]
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("prescriptions")
}

model CartItem {
  id        String   @id @default(cuid())
  userId    String   @db.Uuid
  productId String
  quantity  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("cart_items")
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String   @db.Uuid
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("wishlist_items")
}

model Review {
  id         String   @id @default(cuid())
  userId     String   @db.Uuid
  productId  String
  rating     Int
  comment    String?
  isVerified Boolean  @default(false)
  status     String   @default("pending")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  product    Product  @relation(fields: [productId], references: [id])
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@map("reviews")
}

model SavedKit {
  id          String   @id @default(cuid())
  userId      String   @db.Uuid
  name        String
  description String?
  products    String
  totalPrice  Decimal? @default(0)
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("saved_kits")
}

model Address {
  id           String   @id @default(cuid())
  userId       String   @db.Uuid
  type         String   @default("shipping")
  name         String
  phone        String
  addressLine1 String
  addressLine2 String?
  city         String
  area         String
  postalCode   String?
  latitude     Float?
  longitude    Float?
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   @db.Uuid
  type      String
  title     String
  message   String
  isRead    Boolean  @default(false)
  metadata  String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Promotion {
  id             String   @id @default(cuid())
  code           String   @unique
  title          String
  description    String?
  discountType   String
  discountValue  Decimal
  minOrderAmount Decimal? @default(0)
  maxDiscount    Decimal?
  startDate      DateTime
  endDate        DateTime
  usageLimit     Int?     @default(0)
  usageCount     Int      @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([code])
  @@index([isActive])
  @@map("promotions")
}

model Coupon {
  id             String    @id @default(cuid())
  code           String    @unique
  discountType   String
  discountValue  Decimal
  minOrderAmount Decimal?  @default(0)
  maxDiscount    Decimal?
  expiresAt      DateTime?
  usageLimit     Int?      @default(0)
  usageCount     Int       @default(0)
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

model DeliveryZone {
  id           String   @id @default(cuid())
  name         String
  city         String
  areas        String
  shippingCost Decimal
  deliveryTime String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([city])
  @@index([isActive])
  @@map("delivery_zones")
}

model ChatbotDocument {
  id        String   @id @default(cuid())
  docId     String   @unique
  title     String
  source    String
  category  String?
  content   String
  url       String?
  metadata  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("chatbot_documents")
}

model VectorEmbedding {
  id        String   @id @default(cuid())
  docId     String   @unique
  vector    String?
  metadata  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vector_embeddings")
}

enum GeocodeStatus {
  SUCCESS
  FAILED
  PENDING
}

enum Role {
  USER
  ADMIN
  PHARMACIST
  DELIVERY_PARTNER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PrescriptionStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}
